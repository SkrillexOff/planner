import { initializeApp } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-auth.js";
import { getFirestore, doc, getDoc, getDocs, updateDoc, deleteDoc, setDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.18.0/firebase-firestore.js";

// Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
const firebaseConfig = {
  apiKey: "AIzaSyBYI_LCb4mld3VEfIOU9D49gLV81gKTovE",
  authDomain: "taskcalendarapp-bf3b3.firebaseapp.com",
  databaseURL: "https://taskcalendarapp-bf3b3-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "taskcalendarapp-bf3b3",
  storageBucket: "taskcalendarapp-bf3b3.firebasestorage.app",
  messagingSenderId: "482463811896",
  appId: "1:482463811896:web:11700779551db85f8c59cd",
  measurementId: "G-4V1NYWDVKF"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// –ü–æ–ª—É—á–µ–Ω–∏–µ baseId –∏–∑ URL
const urlParams = new URLSearchParams(window.location.search);
const baseId = urlParams.get("baseId");
if (!baseId) {
  alert("–û—à–∏–±–∫–∞: baseId –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL.");
  window.location.href = "index.html";
}

// –≠–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
const backBtn = document.getElementById('back-btn');
const statusList = document.getElementById('status-list');
const newStatusInput = document.getElementById('new-status');
const addStatusBtn = document.getElementById('add-status-btn');

const participantList = document.getElementById('participant-list');
const newParticipantInput = document.getElementById('new-participant');
const addParticipantBtn = document.getElementById('add-participant-btn');

const loader = document.getElementById('loader');

// –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞–∑–∞–¥
backBtn.addEventListener('click', () => {
  window.location.href = `index.html?baseId=${baseId}`;
});

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
async function loadStatuses() {
  const user = auth.currentUser;
  if (!user) return;

  const baseRef = doc(db, `bases/${baseId}`);
  const baseSnap = await getDoc(baseRef);

  if (baseSnap.exists()) {
    const statusRefs = baseSnap.data().statuses || {};
    const statusPromises = Object.keys(statusRefs).map(async (statusId) => {
      const statusDoc = await getDoc(doc(db, `statuses/${statusId}`));
      return statusDoc.exists() ? { id: statusId, ...statusDoc.data() } : null;
    });

    const statusesArray = (await Promise.all(statusPromises)).filter(Boolean);
    statusesArray.sort((a, b) => a.order - b.order);

    renderStatuses(statusesArray);
  } else {
    alert("–ë–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
    window.location.href = "index.html";
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
function renderStatuses(statuses) {
  statusList.innerHTML = '';
  statuses.forEach((status, index) => {
    const statusItem = document.createElement('li');
    statusItem.dataset.id = status.id;

    statusItem.innerHTML = `
      <span>${status.name}</span>
      <button class="edit-status-btn">‚úèÔ∏è</button>
      <button class="delete-status-btn">üóëÔ∏è</button>
      <button class="move-up-btn">‚Üë</button>
      <button class="move-down-btn">‚Üì</button>
    `;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
    statusItem.querySelector('.edit-status-btn').addEventListener('click', () => {
      const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Å—Ç–∞—Ç—É—Å–∞:', status.name);
      if (newName && newName.trim() !== '') {
        editStatus(status.id, newName.trim());
      }
    });

    statusItem.querySelector('.delete-status-btn').addEventListener('click', () => {
      if (confirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ç—É—Å "${status.name}"?`)) {
        deleteStatus(status.id, statuses);
      }
    });

    statusItem.querySelector('.move-up-btn').addEventListener('click', () => {
      if (index > 0) {
        swapOrders(statuses, index, index - 1);
      }
    });

    statusItem.querySelector('.move-down-btn').addEventListener('click', () => {
      if (index < statuses.length - 1) {
        swapOrders(statuses, index, index + 1);
      }
    });

    statusList.appendChild(statusItem);
  });
}


// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞
addStatusBtn.addEventListener('click', async () => {
  const newStatus = newStatusInput.value.trim();
  if (newStatus) {
    const baseRef = doc(db, `bases/${baseId}`);
    const baseSnap = await getDoc(baseRef);

    if (baseSnap.exists()) {
      const statuses = baseSnap.data().statuses || {};
      const newOrder = Object.keys(statuses).length;

      const newStatusRef = await addDoc(collection(db, 'statuses'), {
        name: newStatus,
        order: newOrder
      });

      statuses[newStatusRef.id] = null;
      await updateDoc(baseRef, { statuses });

      newStatusInput.value = '';
      loadStatuses();
    } else {
      alert("–ë–∞–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.");
      window.location.href = "index.html";
    }
  }
});

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
async function editStatus(id, newName) {
  const statusRef = doc(db, `statuses/${id}`);
  await updateDoc(statusRef, { name: newName });
  loadStatuses();
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞
async function deleteStatus(id, statuses) {
  const baseRef = doc(db, `bases/${baseId}`);
  const baseSnap = await getDoc(baseRef);

  if (baseSnap.exists()) {
    const statusesData = baseSnap.data().statuses || {};
    delete statusesData[id];
    await updateDoc(baseRef, { statuses: statusesData });

    await deleteDoc(doc(db, `statuses/${id}`));

    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä—è–¥–æ–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Å—Ç–∞—Ç—É—Å–æ–≤
    const updatedStatuses = statuses.filter((status) => status.id !== id);
    for (let i = 0; i < updatedStatuses.length; i++) {
      const statusRef = doc(db, `statuses/${updatedStatuses[i].id}`);
      await updateDoc(statusRef, { order: i });
    }

    loadStatuses();
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
async function swapOrders(statuses, fromIndex, toIndex) {
  const fromStatus = statuses[fromIndex];
  const toStatus = statuses[toIndex];

  const fromStatusRef = doc(db, `statuses/${fromStatus.id}`);
  const toStatusRef = doc(db, `statuses/${toStatus.id}`);

  const tempOrder = fromStatus.order;
  await updateDoc(fromStatusRef, { order: toStatus.order });
  await updateDoc(toStatusRef, { order: tempOrder });

  loadStatuses();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º email –∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –±–∞–∑—ã
async function loadParticipants() {
  const user = auth.currentUser;
  if (!user) return;

  const baseRef = doc(db, `bases/${baseId}`);
  const baseSnap = await getDoc(baseRef);

  if (baseSnap.exists()) {
    const sharedWith = baseSnap.data().sharedWith || {}; // –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    const ownerId = baseSnap.data().owner; // –í–ª–∞–¥–µ–ª–µ—Ü –±–∞–∑—ã

    const userIds = [...Object.keys(sharedWith), ownerId];
    const userPromises = userIds.map(async (userId) => {
      const userDoc = await getDoc(doc(db, `users/${userId}`));
      return userDoc.exists() ? { id: userId, email: userDoc.data().email || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" } : null;
    });

    const users = (await Promise.all(userPromises)).filter(Boolean);

    renderParticipants(users, ownerId);
  }
}

// –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å email
function renderParticipants(users, ownerId) {
  participantList.innerHTML = '';
  users.forEach((user) => {
    const participantItem = document.createElement('li');
    participantItem.textContent = user.email;

    if (user.id === ownerId) {
      participantItem.textContent += ' (–í–ª–∞–¥–µ–ª–µ—Ü)';
    } else {
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
      removeBtn.addEventListener('click', () => removeParticipant(user.id));

      participantItem.appendChild(removeBtn);
    }

    participantList.appendChild(participantItem);
  });
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –ø–æ email –∏–ª–∏ ID
addParticipantBtn.addEventListener('click', async () => {
  const input = newParticipantInput.value.trim();
  if (input) {
    const user = auth.currentUser;
    if (!user) return;

    const baseRef = doc(db, `bases/${baseId}`);
    const baseSnap = await getDoc(baseRef);

    if (baseSnap.exists()) {
      let userId = input;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–∫–∞–∑–∞–Ω –ª–∏ email –≤–º–µ—Å—Ç–æ ID
      if (input.includes('@')) {
        const usersQuery = collection(db, 'users');
        const userDocs = await getDocs(usersQuery);
        const matchedUser = userDocs.docs.find((doc) => doc.data().email === input);

        if (matchedUser) {
          userId = matchedUser.id;
        } else {
          alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email –Ω–µ –Ω–∞–π–¥–µ–Ω.');
          return;
        }
      }

      const sharedWith = baseSnap.data().sharedWith || {};
      sharedWith[userId] = null;

      await updateDoc(baseRef, { sharedWith });

      // –û–±–Ω–æ–≤–ª—è–µ–º joinedAt —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userRef = doc(db, `users/${userId}`);
      const userSnap = await getDoc(userRef);

      if (!userSnap.exists()) {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—â–µ –Ω–µ—Ç –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ users, —Å–æ–∑–¥–∞–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
        await setDoc(userRef, { joinedAt: { [baseId]: null } });
      } else {
        const joinedAt = userSnap.data().joinedAt || {};
        joinedAt[baseId] = null;
        await updateDoc(userRef, { joinedAt });
      }

      newParticipantInput.value = '';
      loadParticipants();
    }
  }
});

// –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞
async function removeParticipant(participant) {
  const user = auth.currentUser;
  if (!user) return;

  const baseRef = doc(db, `bases/${baseId}`);
  const baseSnap = await getDoc(baseRef);

  if (baseSnap.exists()) {
    const sharedWith = baseSnap.data().sharedWith || {};
    if (sharedWith[participant] !== undefined) {
      delete sharedWith[participant];
      await updateDoc(baseRef, { sharedWith });

      // –£–¥–∞–ª—è–µ–º baseId –∏–∑ joinedAt –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userRef = doc(db, `users/${participant}`);
      const userSnap = await getDoc(userRef);

      if (userSnap.exists()) {
        const joinedAt = userSnap.data().joinedAt || {};
        delete joinedAt[baseId];
        await updateDoc(userRef, { joinedAt });
      }

      loadParticipants();
    }
  }
}


// –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–∞–¥–µ—Ä
function showLoader() {
  loader.style.display = 'flex';
}

// –°–∫—Ä—ã—Ç—å –ª–æ–∞–¥–µ—Ä
function hideLoader() {
  loader.style.display = 'none';
}

// –í–∫–ª—é—á–∞–µ–º –ª–æ–∞–¥–µ—Ä –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
showLoader();

async function loadData() {
  try {
    await loadStatuses();
    await loadParticipants();
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ", error);
    alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.");
  } finally {
    hideLoader();
  }
}

// –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
onAuthStateChanged(auth, (user) => {
  if (user) {
    loadData();
  } else {
    window.location.href = 'auth.html';
  }
});